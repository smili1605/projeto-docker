name: CI/CD Full Pipeline

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      - name: Run tests
        run: npm test

  terraform:
    name: IaC - Terraform Cloud
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure Terraform Cloud Credentials
        run: |
          mkdir -p ~/.terraform.d
          cat <<EOF > ~/.terraform.d/credentials.tfrc.json
          {
            "credentials": {
              "app.terraform.io": {
                "token": "${{ secrets.TF_API_TOKEN }}"
              }
            }
          }
          EOF

      - name: Setup Terraform CLI
        uses: hashicorp/setup-terraform@v3
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: terraform plan -input=false

      - name: Terraform Apply (via Terraform Cloud)
        run: terraform apply -auto-approve

      - name: Aguardar Terraform Cloud terminar o apply e liberar o IP
        id: fetch-ip
        shell: bash
        run: |
          echo "Aguardando Terraform Cloud terminar o apply..."

          TERRAFORM_BIN="${TERRAFORM_CLI_PATH}/terraform-bin"

          for i in {1..40}; do
            IP=$($TERRAFORM_BIN output -raw droplet_ip 2>/dev/null || true)

            if [[ ! -z "$IP" && "$IP" != *"â•·"* ]]; then
              echo "server_ip=$IP" >> "$GITHUB_OUTPUT"
              echo "IP encontrado: $IP"
              exit 0
            fi

            echo "Ainda nÃ£o disponÃ­vel... ($i/40)"
            sleep 10
          done

          echo "âŒ Falha: Terraform Cloud nÃ£o liberou o IP a tempo."
          exit 1


  deploy:
    name: Deploy da AplicaÃ§Ã£o
    runs-on: ubuntu-latest
    needs: terraform

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Instalar SSH Client
        run: sudo apt-get update && sudo apt-get install -y openssh-client

      - name: Adicionar chave SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DROPLET_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Copiar arquivos para o servidor
        run: |
          rsync -avz -e "ssh -o StrictHostKeyChecking=no" ./ \
            root@${{ needs.terraform.outputs.server_ip }}:/root/app/

      - name: Deploy com Docker
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ needs.terraform.outputs.server_ip }} << 'EOF'
            cd /root/app
            docker stop app || true
            docker rm app || true
            docker build -t app .
            docker run -d --name app -p 80:3000 app
          EOF

      - name: URL Final
        run: echo "ðŸŒŽ AplicaÃ§Ã£o disponÃ­vel em: http://${{ needs.terraform.outputs.server_ip }}"
