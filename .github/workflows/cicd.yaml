name: CI/CD Pipeline
on:
  push:
    branches: ["main"]

jobs:
  # 1. PRIMEIRO: Build Docker (n√£o depende de infra)
  build-docker:
    name: üê≥ Build Docker Image
    runs-on: ubuntu-latest
    outputs:
      docker_tag: ${{ steps.tag.outputs.sha }}
      image_name: ${{ steps.build.outputs.image }}

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üè∑Ô∏è Generate Tag
        id: tag
        run: |
          SHA=$(echo $GITHUB_SHA | head -c7)
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "üÜî Tag: $SHA"

      - name: üîê Login DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: üèóÔ∏è Build & Push
        id: build
        run: |
          TAG=${{ steps.tag.outputs.sha }}
          IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/python-app:$TAG"
          
          echo "üî® Building: $IMAGE"
          docker build -t $IMAGE .
          docker push $IMAGE
          
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "‚úÖ Image pushed"

  # 2. DEPOIS: Terraform (depende do build)
  terraform-infra:
    name: ‚òÅÔ∏è Terraform Plan/Apply
    runs-on: ubuntu-latest
    needs: build-docker  # ‚¨ÖÔ∏è AGORA depende do build primeiro
    outputs:
      droplet_ip: ${{ steps.get_ip.outputs.droplet_ip }}

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"

      - name: üîÑ Terraform Init
        working-directory: ./terraform
        run: terraform init -input=false
        env:
          # ‚¨áÔ∏è VERIFIQUE SE EST√Å USANDO O NOME CERTO DA SECRET
          # Se sua secret se chama TF_TOKEN, troque para: ${{ secrets.TF_TOKEN }}
          TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
          TF_INPUT: "false"

      - name: üìã Terraform Plan
        working-directory: ./terraform
        run: |
          echo "üìù Creating Terraform plan..."
          terraform plan \
            -var="do_token=${{ secrets.DO_TOKEN }}" \
            -var="ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}" \
            -var="ssh_key_name=projeto-$(date +%s)" \
            -input=false -no-color
        env:
          TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}

      - name: üöÄ Terraform Apply (se n√£o for VCS)
        id: apply
        working-directory: ./terraform
        run: |
          echo "üîç Checking workspace mode..."
          
          # Tenta aplicar se n√£o for VCS
          terraform apply -auto-approve \
            -var="do_token=${{ secrets.DO_TOKEN }}" \
            -var="ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}" \
            -input=false -no-color 2>/dev/null && \
          echo "apply_status=success" || \
          echo "apply_status=vcs_mode"
        env:
          TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
        continue-on-error: true

      - name: üåê Get Droplet IP
        id: get_ip
        working-directory: ./terraform
        run: |
          echo "üìç Getting droplet IP..."
          sleep 10
          
          IP=$(terraform output -raw droplet_ip 2>/dev/null || echo "")
          if [ -z "$IP" ]; then
            echo "‚ùå IP not found"
            echo "üí° If using VCS, check: https://app.terraform.io/app/ProjetoDocker/projeto-docker"
            echo "droplet_ip=PENDING_VCS_APPROVAL" >> "$GITHUB_OUTPUT"
          else
            echo "‚úÖ IP: $IP"
            echo "droplet_ip=$IP" >> "$GITHUB_OUTPUT"
          fi
        env:
          TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}

  # 3. FINALMENTE: Deploy (depende de ambos)
  deploy:
    name: üöÄ Deploy to Droplet
    runs-on: ubuntu-latest
    needs: [build-docker, terraform-infra]
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üîë Setup SSH
        uses: webfactory/ssh-agent@v0.9.0  # ‚¨ÖÔ∏è CORRE√á√ÉO AQUI: v0.9.0 em vez de v0.8.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üåê Deploy Application
        run: |
          IP="${{ needs.terraform-infra.outputs.droplet_ip }}"
          TAG="${{ needs.build-docker.outputs.docker_tag }}"
          
          if [ "$IP" = "PENDING_VCS_APPROVAL" ]; then
            echo "‚è≥ Waiting for Terraform Cloud VCS approval"
            echo "üîó Visit: https://app.terraform.io/app/ProjetoDocker/projeto-docker"
            exit 0
          fi
          
          echo "üöÄ Deploying to $IP"
          echo "üì¶ Using tag: $TAG"
          
          # Configura o SSH conhecido
          mkdir -p ~/.ssh
          ssh-keyscan -H "$IP" >> ~/.ssh/known_hosts 2>/dev/null || true
          
          # Envia os arquivos para o droplet
          echo "üì§ Uploading files to droplet..."
          scp -o StrictHostKeyChecking=no \
            docker-compose.yml \
            Dockerfile \
            requirements.txt \
            ubuntu@$IP:/home/ubuntu/ 2>/dev/null || echo "‚ö†Ô∏è  Upload falhou, continuando..."
          
          # Executa o deploy remoto
          echo "‚öôÔ∏è  Executing remote deploy..."
          ssh -o StrictHostKeyChecking=no ubuntu@$IP "
            set -e
            cd /home/ubuntu
            
            # Cria arquivo .env
            echo 'DOCKER_IMAGE_TAG=$TAG' > .env
            echo 'DB_USER=${{ secrets.DB_USER }}' >> .env
            echo 'DB_PASS=${{ secrets.DB_PASS }}' >> .env
            echo 'DB_NAME=${{ secrets.DB_NAME }}' >> .env
            
            # Login no Docker
            docker login -u '${{ secrets.DOCKERHUB_USERNAME }}' -p '${{ secrets.DOCKERHUB_TOKEN }}'
            
            # Para containers existentes e inicia novos
            docker-compose down 2>/dev/null || true
            docker-compose up -d --build
            
            echo '‚úÖ Deploy completo!'
            echo 'üìä Containers em execu√ß√£o:'
            docker ps
          " 2>/dev/null || echo "‚ö†Ô∏è  Deploy falhou, verifique a conectividade SSH"
          
          echo "‚úÖ Deployment ready for IP: $IP"